{% extends "base.html" %}

{% block title %}Study - hashcards{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 2rem; padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;">
    <span style="font-weight: 700; color: var(--accent); font-size: 1.1rem;">{{ card.deck_name }}</span>
    {% if schedule %}
    <span style="color: var(--fg-muted); margin: 0 0.75rem;">•</span>
    <span style="color: var(--fg-secondary); font-weight: 600;">Reviews: {{ schedule.reps }}</span>
    {% if schedule.lapses > 0 %}
    <span style="color: var(--fg-muted); margin: 0 0.75rem;">•</span>
    <span style="color: var(--warning); font-weight: 600;">Lapses: {{ schedule.lapses }}</span>
    {% endif %}
    {% endif %}
</div>

<div class="card" style="min-height: 400px; display: flex; flex-direction: column;">
    <div class="card-content" id="card-content" style="flex: 1; display: flex; align-items: center; justify-content: center;">
        {% if card.card_type.value == 'qa' %}
            {# Question-Answer card #}
            <div id="question-side" style="width: 100%;">
                <div style="color: var(--accent); font-weight: 700; font-size: 1.1rem; margin-bottom: 1rem; letter-spacing: 0.05em;">QUESTION</div>
                <div style="font-size: 1.35rem; line-height: 1.8;">{{ card.content.question }}</div>
            </div>
            <div id="answer-side" style="display: none; width: 100%;">
                <div style="color: var(--success); font-weight: 700; font-size: 1.1rem; margin-bottom: 1rem; letter-spacing: 0.05em;">ANSWER</div>
                <div style="font-size: 1.35rem; line-height: 1.8;">{{ card.content.answer }}</div>
            </div>
        {% else %}
            {# Cloze card #}
            <div id="cloze-hidden" style="width: 100%;">
                <div style="font-size: 1.3rem; line-height: 1.9;">
                    {{ card.content.text | replace('[', '<span class="cloze-hidden">[...') | replace(']', ']</span>') | safe }}
                </div>
            </div>
            <div id="cloze-revealed" style="display: none; width: 100%;">
                <div style="font-size: 1.3rem; line-height: 1.9;">
                    {% set text = card.content.text %}
                    {% for deletion in card.content.deletions %}
                        {% set text = text | replace('[' ~ deletion ~ ']', '<span class="cloze-revealed">' ~ deletion ~ '</span>') %}
                    {% endfor %}
                    {{ text | safe }}
                </div>
            </div>
        {% endif %}
    </div>
    
    <div id="show-answer-btn" class="buttons" style="padding-top: 2rem; border-top: 1px solid var(--border);">
        <button onclick="showAnswer()" style="background: linear-gradient(135deg, var(--accent), var(--accent-hover)); color: white; border: none; padding: 1rem 2.5rem; font-size: 1.05rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
            Show Answer (Space)
        </button>
    </div>
    
    <form method="POST" action="/review" id="review-form" style="display: none;">
        <input type="hidden" name="card_hash" value="{{ card_hash }}">
        <input type="hidden" name="deck_name" value="{{ deck_name or '' }}">
        <input type="hidden" name="rating" id="rating-input">
        
        <div style="padding-top: 2rem; border-top: 1px solid var(--border);">
            <div class="buttons">
                <button type="button" class="again" onclick="submitReview(1)" style="flex: 1; min-width: 140px;">
                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">Again</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; font-weight: 600;">Press 1 • < 10m</div>
                </button>
                <button type="button" class="hard" onclick="submitReview(2)" style="flex: 1; min-width: 140px;">
                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">Hard</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; font-weight: 600;">
                        Press 2 • {% if schedule.scheduled_days < 1 %}< 1d{% else %}{{ (schedule.scheduled_days * 0.8) | int }}d{% endif %}
                    </div>
                </button>
                <button type="button" class="good" onclick="submitReview(3)" style="flex: 1; min-width: 140px;">
                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">Good</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; font-weight: 600;">
                        Press 3 • {% if schedule.scheduled_days < 1 %}1d{% else %}{{ schedule.scheduled_days }}d{% endif %}
                    </div>
                </button>
                <button type="button" class="easy" onclick="submitReview(4)" style="flex: 1; min-width: 140px;">
                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">Easy</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; font-weight: 600;">
                        Press 4 • {% if schedule.scheduled_days < 1 %}2d{% else %}{{ (schedule.scheduled_days * 1.3) | int }}d{% endif %}
                    </div>
                </button>
            </div>
        </div>
    </form>
    
    <div class="keyboard-hint" style="padding-top: 1rem;">
        Press <code>Space</code> to reveal • Then <code>1</code> <code>2</code> <code>3</code> <code>4</code> to rate
    </div>
</div>

<script>
    let answerShown = false;
    
    function showAnswer() {
        {% if card.card_type.value == 'qa' %}
            document.getElementById('answer-side').style.display = 'block';
        {% else %}
            document.getElementById('cloze-hidden').style.display = 'none';
            document.getElementById('cloze-revealed').style.display = 'block';
        {% endif %}
        
        document.getElementById('show-answer-btn').style.display = 'none';
        document.getElementById('review-form').style.display = 'block';
        answerShown = true;
    }
    
    function submitReview(rating) {
        document.getElementById('rating-input').value = rating;
        document.getElementById('review-form').submit();
    }
</script>
{% endblock %}

{% block keyboard_shortcuts %}
    if (e.code === 'Space') {
        e.preventDefault();
        if (!answerShown) {
            showAnswer();
        }
    } else if (answerShown && ['Digit1', 'Digit2', 'Digit3', 'Digit4'].includes(e.code)) {
        e.preventDefault();
        const rating = parseInt(e.code.slice(-1));
        submitReview(rating);
    }
{% endblock %}